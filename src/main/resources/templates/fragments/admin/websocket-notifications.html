<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- WebSocket Notifications Fragment - Include this in all admin pages -->
<div th:fragment="websocket">
    
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- Order Notifications Script -->
    <script th:src="@{/js/admin/order-notifications.js}"></script>
    
    <!-- Fallback Inline WebSocket -->
    <script>
        // Dependency Check
        console.log('üîç WebSocket Dependencies Check:');
        console.log('  - SockJS:', typeof SockJS !== 'undefined' ? '‚úÖ' : '‚ùå');
        console.log('  - Stomp:', typeof Stomp !== 'undefined' ? '‚úÖ' : '‚ùå');
        
        // Fallback if external script fails
        if (typeof SockJS !== 'undefined' && typeof Stomp !== 'undefined') {
            setTimeout(() => {
                if (typeof window.stompClient === 'undefined') {
                    console.log('‚ö†Ô∏è Using inline WebSocket fallback...');
                    
                    const socket = new SockJS('/ws');
                    const stompClient = Stomp.over(socket);
                    stompClient.debug = null;
                    
                    stompClient.connect({}, (frame) => {
                        console.log('‚úÖ [Global] WebSocket Connected!');
                        
                        stompClient.subscribe('/topic/admin/orders', (message) => {
                            const notification = JSON.parse(message.body);
                            console.log('üì¶ [Global] New order:', notification);
                            
                            // Update badge
                            const badge = document.getElementById('order-notification-badge');
                            if (badge) {
                                const currentCount = parseInt(badge.textContent) || 0;
                                badge.textContent = currentCount + 1;
                                badge.style.display = 'inline-block';
                            }
                            
                            // Show alert
                            const customerName = notification.customerName || 'Kh√°ch h√†ng';
                            const orderId = notification.orderId || '?';
                            const totalPrice = (notification.totalPrice || 0).toLocaleString('vi-VN');
                            
                            alert('üõçÔ∏è ƒê∆°n h√†ng m·ªõi!\n\n' +
                                  'Kh√°ch h√†ng: ' + customerName + '\n' +
                                  'M√£ ƒë∆°n: #' + orderId + '\n' +
                                  'T·ªïng ti·ªÅn: ' + totalPrice + ' ‚Ç´');
                            
                            // Reload if on orders page
                            if (window.location.pathname.includes('/admin/order')) {
                                setTimeout(() => location.reload(), 2000);
                            }
                        });
                        
                        console.log('‚úÖ [Global] Subscribed to order notifications');
                    }, (error) => {
                        console.error('‚ùå [Global] WebSocket error:', error);
                    });
                    
                    window.stompClient = stompClient;
                }
            }, 2000);
        }
    </script>
    
</div>

</html>
