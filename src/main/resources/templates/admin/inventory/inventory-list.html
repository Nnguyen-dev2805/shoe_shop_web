<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Title Meta -->
    <meta charset="utf-8"/>
    <title>Danh S√°ch T·ªìn Kho</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Qu·∫£n l√Ω t·ªìn kho s·∫£n ph·∫©m"/>
    <meta name="author" content="Techzaa"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

    <!-- App favicon -->
    <link rel="shortcut icon" th:href="@{/assets/images/favicon.ico}"/>

    <!-- Vendor CSS (Require in all Page) -->
    <link th:href="@{/assets/css/vendor.min.css}" rel="stylesheet" type="text/css"/>

    <!-- Icons CSS (Require in all Page) -->
    <link th:href="@{/assets/css/icons.min.css}" rel="stylesheet" type="text/css"/>

    <!-- App CSS (Require in all Page) -->
    <link th:href="@{/assets/css/app.min.css}" rel="stylesheet" type="text/css"/>

    <!-- Theme Config JS (Require in all Page) -->
    <script th:src="@{/assets/js/config.js}"></script>
    
    <!-- WebSocket for Realtime Updates -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link th:href="@{/css/inventory-realtime.css}" rel="stylesheet" type="text/css"/>

</head>

<body>

<!-- WebSocket Connection Status -->
<div class="websocket-status">
    <span class="badge badge-secondary" id="ws-status">‚óè Connecting...</span>
</div>

<!-- START Wrapper -->
<div class="wrapper">

    <!-- ========== Topbar Start ========== -->
    <div th:replace="~{fragments/admin/panel_menu.html}"></div>
    <!-- ========== Topbar End ========== -->

    <!-- ==================================================== -->
    <!-- Start right Content here -->
    <!-- ==================================================== -->
    <div class="page-content">

        <!-- Start Container Fluid -->
        <div class="container-xxl">

            <!-- Page Title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box">
                        <h4 class="page-title">Danh S√°ch T·ªìn Kho</h4>
                    </div>
                </div>
            </div>

            <!-- Inventory List Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h4 class="card-title">Qu·∫£n l√Ω t·ªìn kho s·∫£n ph·∫©m</h4>
                                </div>
                                <div class="col-auto">
                                    <a href="/admin/inventory/add" class="btn btn-primary">
                                        <i class="bx bx-plus me-1"></i> Th√™m T·ªìn Kho
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Search and Filter -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">S·∫£n ph·∫©m</label>
                                    <select id="productFilter" class="form-select">
                                        <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                                        <!-- Load via AJAX -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Size</label>
                                    <select id="sizeFilter" class="form-select">
                                        <option value="">T·∫•t c·∫£ size</option>
                                        <option value="38">Size 38</option>
                                        <option value="39">Size 39</option>
                                        <option value="40">Size 40</option>
                                        <option value="41">Size 41</option>
                                        <option value="42">Size 42</option>
                                        <option value="43">Size 43</option>
                                        <option value="44">Size 44</option>
                                        <option value="45">Size 45</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="btnSearch" class="btn btn-secondary w-100 d-block">
                                        <i class="bx bx-search-alt"></i> L·ªçc
                                    </button>
                                </div>
                            </div>

                            <!-- Inventory Table -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>S·∫£n ph·∫©m</th>
                                            <th>Size</th>
                                            <th class="text-center">S·ªë l∆∞·ª£ng</th>
                                            <th class="text-center">Tr·∫°ng th√°i</th>
                                            <th class="text-center">H√†nh ƒë·ªông</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <!-- Load via AJAX -->
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="row mt-3">
                                <div class="col-sm-12 col-md-5">
                                    <div class="dataTables_info" id="tableInfo">
                                        Hi·ªÉn th·ªã 0 ƒë·∫øn 0 c·ªßa 0 b·∫£n ghi
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-7">
                                    <ul class="pagination justify-content-end mb-0" id="pagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- End Container Fluid -->

    </div>
    <!-- End Page Content -->

</div>
<!-- END Wrapper -->

<!-- Vendor Javascript (Require in all Page) -->
<script src="/assets/js/vendor.js"></script>

<!-- App Javascript (Require in all Page) -->
<script src="/assets/js/app.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Inventory List Script -->
<script>
let currentPage = 1;
const itemsPerPage = 10;
let totalPages = 0;
let productFilter = '';
let sizeFilter = '';

$(document).ready(function() {
    console.log('üì¶ Inventory List Page Loaded');
    
    // Load products for filter
    loadProducts();
    
    // Load inventory data
    loadInventory(currentPage);
    
    // Product filter change
    $('#productFilter').on('change', function() {
        productFilter = $(this).val();
        loadInventory(1);
    });
    
    // Size filter change
    $('#sizeFilter').on('change', function() {
        sizeFilter = $(this).val();
        loadInventory(1);
    });
    
    // Filter button click
    $('#btnSearch').on('click', function() {
        productFilter = $('#productFilter').val();
        sizeFilter = $('#sizeFilter').val();
        loadInventory(1);
    });
});

// Load products for dropdown
function loadProducts() {
    $.ajax({
        url: '/api/product/list',
        type: 'GET',
        success: function(products) {
            console.log('üì¶ Products loaded:', products);
            products.forEach(function(product) {
                $('#productFilter').append(
                    `<option value="${product.id}">${product.title}</option>`
                );
            });
        },
        error: function(xhr) {
            console.error('‚ùå Failed to load products:', xhr);
        }
    });
}

// Load inventory data
function loadInventory(page) {
    console.log(`üì¶ Loading inventory - page: ${page}, product: "${productFilter}", size: "${sizeFilter}"`);
    
    const tbody = $('#inventoryTableBody');
    tbody.html('<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary"></div></td></tr>');
    
    // Build filter params
    const params = {
        page: page - 1,
        size: itemsPerPage
    };
    
    // Add filters if selected
    if (productFilter) {
        // Get product name to search
        const selectedProduct = $('#productFilter option:selected').text();
        params.search = selectedProduct;
    }
    if (sizeFilter) {
        params.productSize = sizeFilter;
    }
    
    $.ajax({
        url: '/api/inventory',
        type: 'GET',
        data: params,
        success: function(response) {
            console.log('‚úÖ Inventory loaded:', response);
            
            currentPage = response.currentPage || page;
            totalPages = response.totalPages || 1;
            
            renderInventoryTable(response.content || response);
            renderPagination();
            updateTableInfo(response);
        },
        error: function(xhr) {
            console.error('‚ùå Failed to load inventory:', xhr);
            tbody.html(`
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        L·ªói t·∫£i d·ªØ li·ªáu: ${xhr.status} - ${xhr.statusText}
                    </td>
                </tr>
            `);
        }
    });
}

// Render inventory table
function renderInventoryTable(inventories) {
    const tbody = $('#inventoryTableBody');
    
    if (!inventories || inventories.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</td></tr>');
        return;
    }
    
    let rows = '';
    inventories.forEach(function(inv) {
        const stockStatus = getStockStatus(inv.quantity);
        
        rows += `
            <tr data-product-detail-id="${inv.productDetailId}" data-product-id="${inv.productId}">
                <td>${inv.id}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <img src="${inv.productImage || '/assets/images/no-image.png'}" 
                                 alt="${inv.productName}" 
                                 class="rounded" 
                                 style="width: 40px; height: 40px; object-fit: cover;">
                        </div>
                        <div>
                            <h6 class="mb-0">${inv.productName}</h6>
                        </div>
                    </div>
                </td>
                <td><span class="badge bg-secondary">Size ${inv.size}</span></td>
                <td class="text-center">
                    <h5 class="mb-0 ${stockStatus.class} inventory-quantity" data-field="quantity">${inv.quantity}</h5>
                </td>
                <td class="text-center">
                    <span class="badge ${stockStatus.badgeClass}">${stockStatus.text}</span>
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-soft-primary" 
                                onclick="editInventory(${inv.id})" title="Ch·ªânh s·ª≠a">
                            <i class="bx bx-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-soft-danger" 
                                onclick="deleteInventory(${inv.id})" title="X√≥a">
                            <i class="bx bx-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.html(rows);
}

// Get stock status
function getStockStatus(quantity) {
    if (quantity === 0) {
        return {
            class: 'text-danger',
            badgeClass: 'bg-danger',
            text: 'H·∫øt h√†ng'
        };
    } else if (quantity < 10) {
        return {
            class: 'text-warning',
            badgeClass: 'bg-warning',
            text: 'S·∫Øp h·∫øt'
        };
    } else {
        return {
            class: 'text-success',
            badgeClass: 'bg-success',
            text: 'C√≤n h√†ng'
        };
    }
}

// Render pagination
function renderPagination() {
    const pagination = $('#pagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage - 1})">
                <i class="bx bx-chevron-left"></i>
            </a>
        </li>
    `);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const active = i === currentPage ? 'active' : '';
        pagination.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="javascript:void(0);" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }
    
    // Next button
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage + 1})">
                <i class="bx bx-chevron-right"></i>
            </a>
        </li>
    `);
}

// Change page
function changePage(page) {
    if (page < 1 || page > totalPages) return;
    loadInventory(page);
}

// Update table info
function updateTableInfo(response) {
    const total = response.totalElements || 0;
    const start = total === 0 ? 0 : ((currentPage - 1) * itemsPerPage + 1);
    const end = Math.min(currentPage * itemsPerPage, total);
    
    $('#tableInfo').text(`Hi·ªÉn th·ªã ${start} ƒë·∫øn ${end} c·ªßa ${total} b·∫£n ghi`);
}

// Edit inventory
function editInventory(id) {
    console.log('‚úèÔ∏è Edit inventory:', id);
    window.location.href = `/admin/inventory/edit/${id}`;
}

// Delete inventory
function deleteInventory(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi t·ªìn kho n√†y?')) {
        return;
    }
    
    console.log('üóëÔ∏è Delete inventory:', id);
    
    $.ajax({
        url: `/api/inventory/${id}`,
        type: 'DELETE',
        success: function(response) {
            console.log('‚úÖ Delete successful:', response);
            alert('X√≥a th√†nh c√¥ng!');
            loadInventory(currentPage);
        },
        error: function(xhr) {
            console.error('‚ùå Delete failed:', xhr);
            alert('L·ªói: ' + (xhr.responseText || 'Kh√¥ng th·ªÉ x√≥a!'));
        }
    });
}
</script>

<!-- Realtime WebSocket Client -->
<script th:src="@{/js/inventory-realtime.js}"></script>

</body>
</html>
