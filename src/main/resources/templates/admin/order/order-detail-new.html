<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Chi tiết đơn hàng | DeeG Shop Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    
    <!-- Vendor CSS -->
    <link href="/assets/css/vendor.min.css" rel="stylesheet" type="text/css" />
    <link href="/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link href="/assets/css/app.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Custom Shopee Style -->
    <style>
        :root {
            --shopee-primary: #ee4d2d;
            --shopee-hover: #d73211;
            --status-pending: #ffc107;
            --status-shipped: #17a2b8;
            --status-delivered: #28a745;
            --status-cancelled: #dc3545;
            --status-return: #6c757d;
        }
        
        .order-header-shopee {
            background: linear-gradient(135deg, #ee4d2d 0%, #f05a3b 100%);
            padding: 24px;
            border-radius: 8px 8px 0 0;
            color: white;
            margin-bottom: 0;
        }
        
        .status-badge-large {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
        }
        
        .status-IN_STOCK { background: #fff3cd; color: #856404; }
        .status-SHIPPED { background: #d1ecf1; color: #0c5460; }
        .status-DELIVERED { background: #d4edda; color: #155724; }
        .status-CANCEL { background: #f8d7da; color: #721c24; }
        .status-RETURN { background: #e2e3e5; color: #383d41; }
        
        .timeline-shopee {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -29px;
            top: 0;
            width: 2px;
            height: 100%;
            background: #e0e0e0;
        }
        
        .timeline-item:last-child:before {
            display: none;
        }
        
        .timeline-icon {
            position: absolute;
            left: -40px;
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timeline-icon.active {
            border-color: #ee4d2d;
            background: #ee4d2d;
        }
        
        .timeline-icon.active i {
            color: white;
        }
        
        .product-item-shopee {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .product-item-shopee:hover {
            background: #fafafa;
        }
        
        .btn-shopee {
            background: var(--shopee-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-shopee:hover {
            background: var(--shopee-hover);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(238, 77, 45, 0.3);
        }
        
        .btn-outline-shopee {
            background: white;
            color: var(--shopee-primary);
            border: 1px solid var(--shopee-primary);
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-outline-shopee:hover {
            background: var(--shopee-primary);
            color: white;
        }
        
        .info-card-shopee {
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin-bottom: 20px;
        }
        
        .section-title-shopee {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Menu -->
        <div th:include="~{fragments/admin/panel_menu.html}"></div>
        
        <div class="page-content">
            <div class="container-xxl">
                
                <!-- ========== ORDER HEADER ========== -->
                <div class="row">
                    <div class="col-12">
                        <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div class="order-header-shopee">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h3 class="mb-2" style="font-weight: 700;">
                                            <i class="bx bx-shopping-bag me-2"></i>
                                            Đơn hàng #<span th:text="${order.id}">123</span>
                                        </h3>
                                        <p class="mb-0" style="opacity: 0.9;">
                                            <i class="bx bx-calendar me-1"></i>
                                            Ngày đặt: <span th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy HH:mm')}">27/10/2025 14:30</span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <div class="status-badge-large mb-2" th:classappend="${'status-' + order.status}">
                                            <i class="bx bx-info-circle me-1"></i>
                                            <span th:text="${order.status}">IN_STOCK</span>
                                        </div>
                                        <br>
                                        <span class="badge bg-light text-dark" style="font-size: 13px; padding: 6px 12px;">
                                            <i class="bx bx-credit-card me-1"></i>
                                            <span th:text="${order.payOption}">COD</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="card-body" style="background: #fafafa; border-bottom: 1px solid #f0f0f0;">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button th:if="${order.status == T(com.dev.shoeshop.enums.ShipmentStatus).IN_STOCK}" 
                                            class="btn btn-shopee"
                                            onclick="document.getElementById('shipperSearchBox').style.display='block'">
                                        <i class="bx bx-package me-2"></i>
                                        Giao cho vận chuyển
                                    </button>
                                    
                                    <button th:if="${order.status == T(com.dev.shoeshop.enums.ShipmentStatus).IN_STOCK}" 
                                            class="btn btn-outline-danger"
                                            th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        <i class="bx bx-x-circle me-2"></i>
                                        Hủy đơn
                                    </button>
                                    
                                    <button class="btn btn-outline-shopee ms-auto">
                                        <i class="bx bx-printer me-2"></i>
                                        In đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <!-- LEFT COLUMN -->
                    <div class="col-xl-8">
                        
                        <!-- ========== SHIPPER SEARCH BOX ========== -->
                        <div class="card mb-3" id="shipperSearchBox" style="display: none;">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="bx bx-search me-2 text-primary"></i>
                                    Tìm kiếm Shipper
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input id="shipperSearchInput" type="text" class="form-control" 
                                           placeholder="Nhập tên shipper...">
                                    <button id="shipperSearchButton" class="btn btn-shopee">
                                        <i class="bx bx-search"></i> Tìm kiếm
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table id="shipperResultTable" class="table table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tên</th>
                                                <th>Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== ORDER TIMELINE ========== -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="section-title-shopee">
                                    <i class="bx bx-time me-2 text-primary"></i>
                                    Tiến trình đơn hàng
                                </h5>
                                
                                <div class="timeline-shopee">
                                    <!-- Timeline Item 1 -->
                                    <div class="timeline-item">
                                        <div class="timeline-icon active">
                                            <i class="bx bx-check" style="font-size: 12px;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-semibold">Đơn hàng đã đặt</h6>
                                            <p class="text-muted mb-0" style="font-size: 13px;">
                                                <span th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy HH:mm')}">27/10/2025 14:30</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Item 2 -->
                                    <div class="timeline-item" th:if="${order.status != T(com.dev.shoeshop.enums.ShipmentStatus).IN_STOCK && order.status != T(com.dev.shoeshop.enums.ShipmentStatus).CANCEL}">
                                        <div class="timeline-icon active">
                                            <i class="bx bx-check" style="font-size: 12px;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-semibold">Đã giao cho vận chuyển</h6>
                                            <p class="text-muted mb-0" style="font-size: 13px;">
                                                <span th:if="${shipper != null}" th:text="${#dates.format(shipper.createdDate, 'dd/MM/yyyy HH:mm')}">27/10/2025 15:00</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Item 3 -->
                                    <div class="timeline-item" th:if="${order.status == T(com.dev.shoeshop.enums.ShipmentStatus).DELIVERED}">
                                        <div class="timeline-icon active">
                                            <i class="bx bx-check" style="font-size: 12px;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-semibold">Giao hàng thành công</h6>
                                            <p class="text-muted mb-0" style="font-size: 13px;">
                                                <span th:if="${shipper != null}" th:text="${#dates.format(shipper.updatedDate, 'dd/MM/yyyy HH:mm')}">30/10/2025 10:30</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Cancelled -->
                                    <div class="timeline-item" th:if="${order.status == T(com.dev.shoeshop.enums.ShipmentStatus).CANCEL}">
                                        <div class="timeline-icon" style="border-color: #dc3545; background: #dc3545;">
                                            <i class="bx bx-x" style="font-size: 12px; color: white;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-semibold text-danger">Đơn hàng đã hủy</h6>
                                            <p class="text-muted mb-0" style="font-size: 13px;">Đã hủy bởi Admin/Khách hàng</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== PRODUCTS LIST ========== -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="section-title-shopee">
                                    <i class="bx bx-box me-2 text-primary"></i>
                                    Sản phẩm (<span th:text="${#lists.size(list)}">3</span>)
                                </h5>
                                
                                <div>
                                    <div class="product-item-shopee" th:each="detail : ${list}">
                                        <img th:src="${detail.image}" alt="Product" 
                                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #f0f0f0;">
                                        
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" th:text="${detail.product_name}">Nike Air Max</h6>
                                            <p class="text-muted mb-2" style="font-size: 13px;">
                                                Size: <span th:text="${detail.size}">39</span>
                                            </p>
                                            <div class="d-flex align-items-center gap-3">
                                                <span class="text-muted" style="font-size: 14px;">
                                                    x<span th:text="${detail.quantity}">1</span>
                                                </span>
                                                <span class="text-primary fw-semibold">
                                                    <span th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT')}">1,890,000</span>đ
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="text-end">
                                            <p class="mb-0 text-muted" style="font-size: 13px;">Thành tiền</p>
                                            <h6 class="mb-0 text-danger">
                                                <span th:text="${#numbers.formatDecimal(detail.amount, 0, 'COMMA', 0, 'POINT')}">1,890,000</span>đ
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== SHIPPING INFO ========== -->
                        <div class="card mb-3" th:if="${order.status != T(com.dev.shoeshop.enums.ShipmentStatus).CANCEL && order.status != T(com.dev.shoeshop.enums.ShipmentStatus).IN_STOCK}">
                            <div class="card-body">
                                <h5 class="section-title-shopee">
                                    <i class="bx bx-truck me-2 text-primary"></i>
                                    Thông tin vận chuyển
                                </h5>
                                
                                <div class="info-card-shopee" style="background: #f8f9fa;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1" style="font-size: 13px;">Shipper ID</p>
                                            <p class="fw-semibold mb-3" th:text="${shipper?.shipper?.id}">SH001</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1" style="font-size: 13px;">Tên shipper</p>
                                            <p class="fw-semibold mb-3" th:text="${shipper?.shipper?.fullname}">Nguyễn Văn A</p>
                                        </div>
                                        <div class="col-12">
                                            <p class="text-muted mb-1" style="font-size: 13px;">Ghi chú</p>
                                            <p class="mb-0" th:text="${shipper?.note}">Giao hàng giờ hành chính</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- RIGHT COLUMN -->
                    <div class="col-xl-4">
                        
                        <!-- ========== ORDER SUMMARY ========== -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="section-title-shopee">
                                    <i class="bx bx-receipt me-2 text-primary"></i>
                                    Tóm tắt đơn hàng
                                </h5>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Tạm tính:</span>
                                    <span th:text="${#numbers.formatDecimal(payment.subtotal, 0, 'COMMA', 0, 'POINT') + 'đ'}">2,500,000đ</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Giảm giá:</span>
                                    <span class="text-success" th:text="'-' + ${#numbers.formatDecimal(payment.discount, 0, 'COMMA', 0, 'POINT') + 'đ'}">-100,000đ</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-2" th:if="${order.coinsUsed != null && order.coinsUsed > 0}">
                                    <span class="text-muted">
                                        <i class="bx bx-coin me-1"></i>
                                        Sử dụng xu:
                                    </span>
                                    <span class="text-warning" th:text="'-' + ${#numbers.formatDecimal(order.coinsDiscount, 0, 'COMMA', 0, 'POINT') + 'đ'}">-50,000đ</span>
                                </div>
                                
                                <hr>
                                
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-0">Tổng cộng:</h6>
                                    <h5 class="mb-0 text-danger fw-bold">
                                        <span th:text="${#numbers.formatDecimal(payment.totalpay, 0, 'COMMA', 0, 'POINT') + 'đ'}">2,400,000đ</span>
                                    </h5>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== CUSTOMER INFO ========== -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="section-title-shopee">
                                    <i class="bx bx-user me-2 text-primary"></i>
                                    Thông tin khách hàng
                                </h5>
                                
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <img src="/assets/images/users/avatar-1.jpg" alt="Avatar" 
                                         class="rounded-circle" style="width: 50px; height: 50px; border: 2px solid #f0f0f0;">
                                    <div>
                                        <h6 class="mb-0" th:text="${user.fullname}">Nguyễn Văn B</h6>
                                        <p class="text-muted mb-0" style="font-size: 13px;" th:text="${user.email}">email@example.com</p>
                                    </div>
                                </div>
                                
                                <div class="info-card-shopee">
                                    <p class="text-muted mb-1" style="font-size: 13px;">
                                        <i class="bx bx-phone me-1"></i>
                                        Số điện thoại
                                    </p>
                                    <p class="fw-semibold mb-3" th:text="${user.phone}">0968543251</p>
                                    
                                    <p class="text-muted mb-1" style="font-size: 13px;">
                                        <i class="bx bx-map me-1"></i>
                                        Địa chỉ giao hàng
                                    </p>
                                    <p class="mb-0" th:if="${user?.userAddresses != null and !user.userAddresses.empty}" 
                                       th:text="${user.userAddresses[0].address.addressLine + ', ' + user.userAddresses[0].address.district + ', ' + user.userAddresses[0].address.city}">
                                        123 Nguyễn Huệ, Q1, TP.HCM
                                    </p>
                                    <p class="mb-0 text-muted" th:unless="${user?.userAddresses != null and !user.userAddresses.empty}">
                                        Chưa cập nhật
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 text-center">
                        <script>document.write(new Date().getFullYear())</script> &copy; DeeG Shop Admin
                    </div>
                </div>
            </div>
        </footer>
        
    </div>
    
    <!-- Cancel Order Fragment -->
    <div th:include="~{fragments/order/order_cancel.html}"></div>
    
    <!-- Scripts -->
    <script src="/assets/js/vendor.js"></script>
    <script src="/assets/js/app.js"></script>
    
    <!-- Shipper Search Script -->
    <script>
        $(document).ready(function() {
            const orderId = window.location.pathname.split('/')[4];
            
            $("#shipperSearchButton").click(function() {
                const fullname = $("#shipperSearchInput").val();
                
                if (fullname.trim() !== "") {
                    $.ajax({
                        url: "/api/shipper/search",
                        type: "GET",
                        data: { name: fullname },
                        success: function(response) {
                            $("#shipperResultTable tbody").empty();
                            
                            if (response.length > 0) {
                                response.forEach(function(user) {
                                    $("#shipperResultTable tbody").append(`
                                        <tr>
                                            <td>${user.id}</td>
                                            <td>${user.name}</td>
                                            <td>
                                                <a class="btn btn-sm btn-shopee" 
                                                   href='/manager/order/shipping?orderid=${orderId}&userid=${user.id}'>
                                                    <i class="bx bx-check"></i> Giao hàng
                                                </a>
                                            </td>
                                        </tr>
                                    `);
                                });
                            } else {
                                $("#shipperResultTable tbody").append(
                                    "<tr><td colspan='3' class='text-center text-muted'>Không tìm thấy shipper</td></tr>"
                                );
                            }
                        },
                        error: function(error) {
                            console.error("Lỗi khi gọi API", error);
                            alert("Có lỗi xảy ra khi tìm kiếm shipper");
                        }
                    });
                }
            });
            
            // Enter key support
            $("#shipperSearchInput").keypress(function(e) {
                if (e.which === 13) {
                    $("#shipperSearchButton").click();
                }
            });
        });
        
        function cancelOrder(orderId) {
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng #' + orderId + '?')) {
                // Call cancel API here
                window.location.href = '/manager/order/cancel/' + orderId;
            }
        }
    </script>
    
</body>
</html>
